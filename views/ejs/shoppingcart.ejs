<!DOCTYPE html>
<html lang="en">

<head>
    <!-- basic -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- mobile metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <!-- site metas -->
    <title>Racing Boot</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- bootstrap css -->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <!-- style css -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- Responsive-->
    <link rel="stylesheet" href="../css/responsive.css">
    <!-- fevicon -->
    <link rel="icon" href="../images/fevicon.png" type="image/gif" />
    <!-- Scrollbar Custom CSS -->
    <link rel="stylesheet" href="../css/jquery.mCustomScrollbar.min.css">
    <!-- Tweaks for older IEs-->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
    <!-- owl stylesheets -->
    <link rel="stylesheet" href="../css/owl.carousel.min.css">
    <link rel="stylesheet" href="../css/owl.theme.default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css"
        media="screen">
    <style>
        td{
            padding: 10px;
        }
    </style>
</head>
<!-- body -->

<body class="main-layout">
    <!-- header section start -->
    <div class="header_section">
        <%- include('./component/header.ejs') %>
    </div>
    <!-- new collection section start -->
    <div class="collection_text">Giỏ hàng của bạn</div>
    <div class="about_main layout_padding">
        <div class="collectipn_section_3 layout_padding">
            <div class="container">
                <div class="racing_shoes">
                        <div class="row" style="margin-left: 20px; margin-right: 0px; height: 500px;">
                            <table id="cart-table" style="margin: 0px auto;" border="1">
                                <% if(!products){ %>
                                    <div
                                        style="width: 100%;
                                                                                                                                background-image: url(../images/empty-cart.png);
                                                                                                                                height: 100%;
                                                                                                                                background-repeat: no-repeat;
                                                                                                                                background-position: center; text-align: center;">
                                        <h1>Giỏ Hàng Trống!</h1>
                                    </div>
                                    <%}else{ for(let product of products){ %>
                                        <tr data-id="<%=product._id%>">
                                            <td>
                                                <img style="max-width: 200px;top: 50%;left: 50%;position: relative;transform: translate(-50%, 0px);"
                                                    src="../images/products/<%=product.image%>" alt="">
                                            </td>
                                            <td style="word-wrap: break-word;max-width: 150px;">
                                                <%=product._id%>
                                            </td>
                                            <td>
                                                <%=(product.specialPrice>0)?product.specialPrice: product.price%>
                                            </td>
                                            <td><input type="number" id="amount" required></td>
                                        </tr>
                                    <%}}%>
                            </table>
                        </div>
                        <% if(products){ %>
                        <div style="float: right; margin-right: 20px;">
                            <button onclick="sendProducts()" class="btn btn-success" type="button">Tiến hành thanh toán</button>
                        </div>
                        <%}%>
                </div>
            </div>
        </div>
    </div>
    <!-- new collection section end -->
    <!-- section footer start -->
    <%-include('./component/footer.ejs')%>

    <script>
        async function sendProducts() {
            let rows = document.querySelectorAll("#cart-table tr")
            let products = []

            rows.forEach(o => {
                let id = o.dataset.id
                let amount = o.querySelector('#amount')
                amount = amount ?Number.parseInt(amount.value):1
                products.push({ id, amount })
            })
            let _idUser = '<%=user._id%>'
            fetch('/order/confirm', {
                method: 'POST',
                headers: {'Content-type': 'application/json'},
                body: JSON.stringify({ _idUser ,products })
            }).then(async res => {
                let data = await res.json()
                window.location.href = data.redirect
            })
        }
    </script>
</body>

</html>